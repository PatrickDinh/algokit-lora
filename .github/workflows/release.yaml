name: Release

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'docs/**'
      - '**.md'
      - '.vscode/**'
      - '.idea/**'
  workflow_dispatch:
    inputs:
      production-release:
        description: 'Production release?'
        required: true
        default: 'true'

concurrency: create-release

permissions:
  contents: write # to be able to publish a GitHub release
  issues: write # to be able to comment on released issues
  pull-requests: write # to be able to comment on released pull requests
  packages: read

env:
  PRODUCTION_RELEASE: ${{ github.ref_name == 'main' && inputs.production-release == 'true' }}

jobs:
  create-release:
    runs-on: [ubuntu-20.04]
    name: Create release
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create GitHub release
        uses: ./.github/actions/create-release
        id: create-release-action
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          production-release: ${{ env.PRODUCTION_RELEASE }}
          node-version: 20

      - name: Create draft CrabNebula release
        uses: crabnebula-dev/cloud-release@v0.2.0
        if: ${{ steps.create-release-action.outputs.release-published == 'true' }}
        with:
          command: release draft ${{ secrets.CN_ORG_NAME }}/${{ secrets.CN_APP_NAME }} ${{ steps.create-release-action.outputs.release-version }} ${{ env.PRODUCTION_RELEASE == 'true' && '' || '--channel beta' }}
          api-key: ${{ secrets.CN_API_KEY }}

    outputs:
      release-published: ${{ steps.create-release-action.outputs.release-published }}
      release-version: ${{ steps.create-release-action.outputs.release-version }}
      release-tag: ${{ steps.create-release-action.outputs.release-tag }}
      release-id: ${{ steps.create-release-action.outputs.release-id }}

  build-tauri:
    name: Build Tauri app
    needs:
      - create-release
    runs-on: ${{ matrix.platform }}
    strategy:
      matrix:
        # macos-14 is the Apple Silicon M1 runner
        platform: ['macos-14']
    if: ${{ needs.create-release.outputs.release-published == 'true' }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Install npm dependencies
        run: npm install

      - name: Create .env file
        run: |
          sed -E -n 's/(VITE_[A-Z0-9_]+)=(.*)/\1="{{\1}}"/p' .env.sample > .env

      - name: Substitute environment variables
        uses: bluwy/substitute-string-action@v3
        with:
          _input-file: '.env'
          _format-key: '{{key}}'
          _output-file: '.env'
          VITE_DISPENSER_AUTH0_DOMAIN: dispenser-prod.eu.auth0.com
          VITE_DISPENSER_AUTH0_CLIENT_ID: Cg13HjvSV45pMme4dnK9yVJde8tVeDaM
          VITE_DISPENSER_AUTH0_AUDIENCE: api-prod-dispenser-user
          VITE_TESTNET_DISPENSER_API_URL: https://api.dispenser.algorandfoundation.tools
          VITE_TESTNET_DISPENSER_ADDRESS: Z5GPJQCHVU54C2I4FLYNE2XHRQRL5OV2GPJQKXJFMW34CRIN2KRQFXF7DI

      # - name: Build for Mac
      #   id: build-mac
      #   if: ${{ runner.os == 'macOS' }}
      #   uses: ./.github/actions/build-mac
      #   with:
      #     release-version: ${{ needs.create-release.outputs.release-version }}
      #     apple-certificate: ${{ secrets.APPLE_CERTIFICATE }}
      #     apple-certificate-password: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
      #     keychain-password: ${{ secrets.KEYCHAIN_PASSWORD }}
      #     apple-id: ${{ secrets.APPLE_ID }}
      #     apple-password: ${{ secrets.APPLE_PASSWORD }}
      #     apple-team-id: ${{ secrets.APPLE_TEAM_ID }}
      #     tauri-signing-public-key: ${{ secrets.TAURI_SIGNING_PUBLIC_KEY }}
      #     tauri-signing-private-key: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
      #     tauri-signing-private-key-password: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
      #     crabnebula-org-name: ${{ secrets.CN_ORG_NAME }}
      #     crabnebula-app-name: ${{ secrets.CN_APP_NAME }}
      #     crabnebula-api-key: ${{ secrets.CN_API_KEY }}
